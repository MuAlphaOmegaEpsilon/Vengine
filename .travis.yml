language: cpp
dist: bionic
git:
  depth: false

matrix:
  fast_finish: true
  include:
  
  - os: linux
    compiler: gcc  
    env: 
    - CMAKE_ARGS="-DBUILD_WSI_XCB_SUPPORT=OFF -DBUILD_WSI_XLIB_SUPPORT=OFF -DBUILD_WSI_WAYLAND_SUPPORT=OFF -DCOVERAGE_FLAG=--coverage"
    - CMAKE_BUILD_WRAPPER="build-wrapper-linux-x86-64 --out-dir ."    
    addons:
      apt:
        packages: mesa-vulkan-drivers
      sonarcloud:
        organization: "mualphaomegaepsilon-github"
    before_script: sudo rm /usr/bin/gcov && sudo ln -s /usr/bin/gcov-5 /usr/bin/gcov
    after_script: sonar-scanner
        
  - os: linux
    compiler: clang
    env: CMAKE_ARGS="-DBUILD_WSI_XCB_SUPPORT=OFF -DBUILD_WSI_XLIB_SUPPORT=OFF -DBUILD_WSI_WAYLAND_SUPPORT=OFF"
    addons:
      apt:
        packages: mesa-vulkan-drivers
    
  - os: osx
    osx_image: xcode11
  
  - os: windows
    env: CMAKE_ARGS="-DWDK_FULL_PATH=$HOME/WDK_DIR"
    install: 
    - choco install windowsdriverkit10
    - ln -s "C:/Program Files (x86)/Windows Kits/10/Include/10.0.17763.0" $HOME/WDK_DIR

script:
- mkdir -p tests/build && cd tests/build
- cmake .. ${CMAKE_ARGS}
- ${CMAKE_BUILD_WRAPPER} cmake --build .
# Only test runtime under Linux, since osx and Windows are missing drivers
- if [ "$TRAVIS_OS_NAME" = "linux" ]; then ctest -j2; fi
